#! /bin/hilbish
-- ssf: minimal screenshot script for sharex hosts - upload local file
-- requirements: xclip, maim, curl, jq, notify-send
-- usage: ssf <path-to-file>

local usage = [[
usage: ssf filepath

upload a local image to sharex host
]]

function runcmd(cmd, giveout)
	if giveout then
		local f = io.popen(cmd)
		local output = f:read '*all'
		local out = output:gsub('\n', '')
		f:close()

		return out
	else
		os.execute(cmd)
	end
end

if #args < 2 then
	print(usage)
	os.exit(1)
end

local path = args[2]
-- URL to uplaod to
local url = 'https://modeus.is-inside.me/upload'
-- Authentication Key
-- You should change this to a value that makes sense for you
local authtoken = '$(cat $HOME/.apikey)'
-- Key name of the field to use authkey
local formkey = 'key'
-- JSON key to image URl
local image = 'url'

local jsonstr = runcmd('curl -s --request POST -H "' ..  formkey .. ':'
.. authtoken .. '" -F file=@' .. path .. ' ' .. url, true)

local obj = loadstring('return '
.. jsonstr:gsub('("[^"]-"):', '[%1]='))()
local url = obj[image]

print(url)

runcmd('echo -n ' .. url .. ' | xclip -selection clipboard')
runcmd 'notify-send -i /tmp/screenshot.png -t 6000 "ssf-lua" "Screenshot uploaded!"'
