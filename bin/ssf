#! /bin/hilbish
-- ssf: minimal screenshot script for sharex hosts - upload local file
-- requirements: xclip, maim, curl, jq, notify-send
-- usage: ssf <path-to-file>

local usage = [[
usage: ssf filepath

upload a local image to sharex host
]]

if #args > 0 then
	print(usage)
	os.exit(1)
end

local path = args[1]
-- URL to uplaod to
local url = 'https://modeus.is-inside.me/upload'
-- Authentication Key
-- You should change this to a value that makes sense for you
local authtoken = '$(cat $HOME/.apikey)'
-- Key name of the field to use authkey
local formkey = 'key'
-- JSON key to image URl
local image = 'url'

local jsonstr = runcmd('curl --request POST -H "' .. 
formkey ':' .. authtoken .. ' -F file=@$@ ' .. url, true)
local obj = loadstring('return '
.. jsonstr:gsub('("[^"]-"):', '[%1]='))()
local url = obj[image]
print(url)
runcmd('echo ' .. url .. ' | xclip -selection clipboard')
runcmd 'notify-send "ssf-lua" "Screenshot uploaded!"'
