#! /bin/hilbish
-- ssf: minimal screenshot script for sharex hosts - upload local file
-- requirements: xclip, maim, curl, jq, notify-send
-- usage: ssf <path-to-file>

local usage = [[
usage: ssf filepath

upload a local image to sharex host
]]

function runcmd(cmd, giveout)
	if giveout then
		local f = io.popen(cmd)
		local output = f:read '*all'
		local out = output:gsub('\n', '')
		f:close()

		return out
	else
		os.execute(cmd)
	end
end

if #args < 2 then
	print(usage)
	os.exit(1)
end

local path = args[2]
-- URL to uplaod to
local url = 'https://safe.kashima.moe/api/upload'
-- Authentication Key
-- You should change this to a value that makes sense for you
local authtoken = '$(cat $HOME/.apikey)'
local formfile = 'files'
local filearray = true

-- JSON key to image URl
local image = 'url'
local headers = {
	Accept = 'application/vnd.chibisafe.json',
	Token = authtoken
}

local headerstr = ''
-- format for curl
for k, v in pairs(headers) do
	headerstr = headerstr .. '-H "' .. k .. ': ' .. v .. '" '
end
local arr = (filearray and '[]' or '')

local jsonstr = runcmd(string.format('curl -s --request POST -F "%s%s=@%s" %s%s', formfile, arr, path, headerstr, url), true)
print(jsonstr)
local obj = loadstring('return '
.. jsonstr:gsub('("[^"]-"):', '[%1]='))()
local url = obj[image]

print(url)

runcmd('echo -n ' .. url .. ' | xclip -selection clipboard')
runcmd 'notify-send -i /tmp/screenshot.png -t 6000 "ssf-lua" "Screenshot uploaded!"'
